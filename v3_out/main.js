var SuperCreep = (function () {
    function SuperCreep() {
    }
    SuperCreep.prototype.howManyParts = function (part) {
        return this.body.filter(function (s) { return (s.type == part && s.hits > 0); }).length;
    };
    SuperCreep.prototype.hasPart = function (part) {
        return this.howManyParts(part) > 0;
    };
    SuperCreep.prototype.canMove = function () {
        return this.hasPart(MOVE);
    };
    SuperCreep.prototype.canWork = function () {
        return this.hasPart(WORK);
    };
    SuperCreep.prototype.canHeal = function () {
        return this.hasPart(HEAL);
    };
    SuperCreep.prototype.canAttack = function () {
        return this.hasPart(ATTACK);
    };
    SuperCreep.prototype.canShoot = function () {
        return this.hasPart(RANGED_ATTACK);
    };
    SuperCreep.prototype.canClaim = function () {
        return this.hasPart(CLAIM);
    };
    SuperCreep.prototype.log = function () {
        var msg = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            msg[_i - 0] = arguments[_i];
        }
        console.log.apply(console, ["[" + this.name + "]"].concat(msg));
    };
    return SuperCreep;
})();
function applyMixins(derivedCtor, baseCtors) {
    baseCtors.forEach(function (baseCtor) {
        Object.getOwnPropertyNames(baseCtor.prototype).forEach(function (name) {
            derivedCtor.prototype[name] = baseCtor.prototype[name];
        });
    });
}
applyMixins(Creep, [SuperCreep]);
var setJob = function (creep, job) {
    Memory['job_workers'][job.name] = creep.name;
    job.creep = creep;
    creep.job = job;
};
var Roles = {
    megaMiner: function (creep, job) {
        creep.log(job.name);
        var sourceId = creep.memory.sId;
        var source;
        if (sourceId != undefined) {
            source = Game.getObjectById(sourceId);
        }
        if (source == undefined) {
            if (!creep.pos.isNearTo(job.start)) {
                creep.moveTo(job.start, { reusePath: 20, maxOps: 1000 });
            }
            creep.log(job.start);
            source = job.start.pos.findClosestByRange(FIND_SOURCES);
            if (source != undefined) {
                creep.memory.sId = source.id;
            }
        }
        if (source != undefined) {
            var err = creep.harvest(source);
            if (err == ERR_NOT_IN_RANGE) {
                err = creep.moveTo(source);
            }
        }
        return err;
    }
};
var Filters = {
    worksAndMoves: function (creep) {
        return creep.canWork() && creep.canMove();
    }
};
var Cmp = {
    worksHard: function (a, b) {
        return b.howManyParts(WORK) - a.howManyParts(WORK);
    },
};
var jobs = [{
        name: "mega_miner_1",
        start: Game.flags['Mine_1_1'],
        jobFunc: Roles['megaMiner'],
        candidateFilter: Filters['worksAndMoves'],
        candidateCmp: Cmp['worksHard']
    }, {
        name: "mega_miner_2",
        start: Game.flags['Mine_1_2'],
        jobFunc: Roles['megaMiner'],
        candidateFilter: Filters['worksAndMoves'],
        candidateCmp: Cmp['worksHard']
    }];
if (Memory['job_workers'] == undefined) {
    console.log("replacing worker map1!!");
    Memory['job_workers'] = {};
}
var creeps = [];
for (var _i = 0, _a = Object.keys(Game.creeps); _i < _a.length; _i++) {
    var n = _a[_i];
    creeps.push(Game.creeps[n]);
}
var seenJobs = {};
var emptyJobs = [];
for (var _b = 0; _b < jobs.length; _b++) {
    var job = jobs[_b];
    if (seenJobs[job.name]) {
        console.log("DUPLICATE JOB IN LIST!! " + job.name);
    }
    seenJobs[job.name] = true;
    var creepName = Memory['job_workers'][job.name];
    var creep;
    if (creepName != undefined) {
        creep = Game.creeps[creepName];
        if (creep == undefined) {
            console.log("Bad creep found, replacing: " + JSON.stringify(creep));
            delete Memory['job_workers'][job.name];
            creepName = undefined;
        }
        else {
            setJob(creep, job);
        }
    }
    if (creepName == undefined) {
        emptyJobs.push(job);
    }
}
var noJob = function (c) {
    return c.job == undefined;
};
for (var _c = 0; _c < emptyJobs.length; _c++) {
    var job = emptyJobs[_c];
    console.log("Need to replace creep for job " + job.name);
    var candidates = creeps.filter(noJob).filter(job.candidateFilter).sort(job.candidateCmp);
    if (candidates.length > 0) {
        var creep = candidates[0];
        console.log("Picked creep for job " + job.name + " got " + creep.name);
        setJob(creep, job);
    }
    else {
        console.log("no candidates for job=" + job.name);
        continue;
    }
}
job = null;
for (var _d = 0; _d < creeps.length; _d++) {
    creep = creeps[_d];
    if (creep.job != undefined) {
        creep.log("job=" + creep.job.name);
        creep.job.jobFunc(creep, creep.job);
    }
    else {
        creep.log("Nothing to do");
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3YzL2dsb2JhbHMudHMiLCIuLi92My9tYWluLnRzIl0sIm5hbWVzIjpbIlN1cGVyQ3JlZXAiLCJTdXBlckNyZWVwLmNvbnN0cnVjdG9yIiwiU3VwZXJDcmVlcC5ob3dNYW55UGFydHMiLCJTdXBlckNyZWVwLmhhc1BhcnQiLCJTdXBlckNyZWVwLmNhbk1vdmUiLCJTdXBlckNyZWVwLmNhbldvcmsiLCJTdXBlckNyZWVwLmNhbkhlYWwiLCJTdXBlckNyZWVwLmNhbkF0dGFjayIsIlN1cGVyQ3JlZXAuY2FuU2hvb3QiLCJTdXBlckNyZWVwLmNhbkNsYWltIiwiU3VwZXJDcmVlcC5sb2ciLCJhcHBseU1peGlucyJdLCJtYXBwaW5ncyI6IkFBT0E7SUFBQUE7SUFnREFDLENBQUNBO0lBbkNHRCxpQ0FBWUEsR0FBWkEsVUFBYUEsSUFBV0E7UUFDdEJFLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLFVBQUFBLENBQUNBLElBQU1BLE1BQU1BLENBQUNBLENBQUNBLENBQUNBLENBQUNBLElBQUlBLElBQUlBLElBQUlBLElBQUlBLENBQUNBLENBQUNBLElBQUlBLEdBQUdBLENBQUNBLENBQUNBLENBQUFBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLE1BQU1BLENBQUFBO0lBQ2hGQSxDQUFDQTtJQUVERiw0QkFBT0EsR0FBUEEsVUFBUUEsSUFBWUE7UUFDbEJHLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLFlBQVlBLENBQUNBLElBQUlBLENBQUNBLEdBQUdBLENBQUNBLENBQUFBO0lBQ3BDQSxDQUFDQTtJQUVESCw0QkFBT0EsR0FBUEE7UUFDSUksTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7SUFDOUJBLENBQUNBO0lBRURKLDRCQUFPQSxHQUFQQTtRQUNJSyxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxD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QUMsZUFBZSxDQUFDLENBQUE7SUFDOUIsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiLy8vIDxyZWZlcmVuY2UgcGF0aD1cInNjcmVlcHMuZC50c1wiIC8+XG5cblxuaW50ZXJmYWNlIFNjcmVlcCBleHRlbmRzIENyZWVwLCBTdXBlckNyZWVwe1xuICAgIGpvYj8gOiBKb2I7XG59XG5cbmNsYXNzIFN1cGVyQ3JlZXAge1xuICAgIG5hbWU6IHN0cmluZztcbiAgICBib2R5OiB7XG5cbiAgICAgICAgLyoqIE9uZSBvZiB0aGUgYm9keSBwYXJ0cyBjb25zdGFudHMuICovXG4gICAgICAgIHR5cGU6IHN0cmluZztcblxuICAgICAgICAvKiogVGhlIHJlbWFpbmluZyBhbW91bnQgb2YgaGl0IHBvaW50cyBvZiB0aGlzIGJvZHkgcGFydC4gKi9cbiAgICAgICAgaGl0czogbnVtYmVyXG5cbiAgICB9W107XG5cblxuICAgIGhvd01hbnlQYXJ0cyhwYXJ0OnN0cmluZyk6bnVtYmVyIHtcbiAgICAgIHJldHVybiB0aGlzLmJvZHkuZmlsdGVyKHMgPT4geyByZXR1cm4gKHMudHlwZSA9PSBwYXJ0ICYmIHMuaGl0cyA+IDApIH0pLmxlbmd0aCBcbiAgICB9XG5cbiAgICBoYXNQYXJ0KHBhcnQ6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgcmV0dXJuIHRoaXMuaG93TWFueVBhcnRzKHBhcnQpID4gMFxuICAgIH1cblxuICAgIGNhbk1vdmUoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmhhc1BhcnQoTU9WRSk7XG4gICAgfVxuXG4gICAgY2FuV29yaygpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaGFzUGFydChXT1JLKTtcbiAgICB9XG5cbiAgICBjYW5IZWFsKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5oYXNQYXJ0KEhFQUwpO1xuICAgIH1cblxuICAgIGNhbkF0dGFjaygpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaGFzUGFydChBVFRBQ0spO1xuICAgIH1cblxuICAgIGNhblNob290KCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5oYXNQYXJ0KFJBTkdFRF9BVFRBQ0spO1xuICAgIH1cblxuICAgIGNhbkNsYWltKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5oYXNQYXJ0KENMQUlNKTtcbiAgICB9XG5cbiAgICBsb2coLi4ubXNnKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiW1wiK3RoaXMubmFtZStcIl1cIiwgLi4ubXNnKVxuICAgIH1cbn1cblxuXG5cblxuZnVuY3Rpb24gYXBwbHlNaXhpbnMoZGVyaXZlZEN0b3I6IGFueSwgYmFzZUN0b3JzOiBhbnlbXSkge1xuICAgIGJhc2VDdG9ycy5mb3JFYWNoKGJhc2VDdG9yID0+IHtcbiAgICAgICAgT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMoYmFzZUN0b3IucHJvdG90eXBlKS5mb3JFYWNoKG5hbWUgPT4ge1xuICAgICAgICAgICAgZGVyaXZlZEN0b3IucHJvdG90eXBlW25hbWVdID0gYmFzZUN0b3IucHJvdG90eXBlW25hbWVdO1xuICAgICAgICB9KVxuICAgIH0pOyBcbn1cblxuXG5hcHBseU1peGlucyhDcmVlcCwgW1N1cGVyQ3JlZXBdKVxuXG4iLCIvLy8gPHJlZmVyZW5jZSBwYXRoPVwic2NyZWVwcy5kLnRzXCIgLz5cbi8vLyA8cmVmZXJlbmNlIHBhdGg9XCJnbG9iYWxzLnRzXCIgLz5cblxuLy9yZXF1aXJlKCdnbG9iYWxzJylcblxuLy8gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMoU3VwZXJDcmVlcC5wcm90b3R5cGUpLmZvckVhY2gobmFtZSA9PiB7XG4vLyAgIENyZWVwLnByb3RvdHlwZVtuYW1lXSA9IFN1cGVyQ3JlZXAucHJvdG90eXBlW25hbWVdXG4vLyB9KVxuXG50eXBlIEpvYkZ1bmMgPSAoY3JlZXA6IFNjcmVlcCwgam9iOiBKb2IpID0+IG51bWJlcjtcbnR5cGUgQ3JlZXBGaWx0ZXIgPSAoY3JlZXA6IFNjcmVlcCkgPT4gYm9vbGVhbjtcbnR5cGUgQ3JlZXBDbXAgPSAoYTogQ3JlZXAsIGI6IFNjcmVlcCkgPT4gbnVtYmVyO1xuXG5cblxuaW50ZXJmYWNlIFBvc2l0aW9uRW50aXR5IHtcbiAgICBwb3MgOiBSb29tUG9zaXRpb25cbn1cblxuXG5pbnRlcmZhY2UgSm9iIHtcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgc3RhcnQ6IFBvc2l0aW9uRW50aXR5O1xuICAgIGVuZD86IFBvc2l0aW9uRW50aXR5O1xuICAgIGpvYkZ1bmM6IEpvYkZ1bmM7XG4gICAgY2FuZGlkYXRlRmlsdGVyOiBDcmVlcEZpbHRlcjtcbiAgICBjYW5kaWRhdGVDbXA6IENyZWVwQ21wO1xuICAgIGNyZWVwPzogU2NyZWVwOyAvLyBTZXQgZHVyaW5nIGV4ZWN1dGlvbmdcbn1cblxuXG52YXIgc2V0Sm9iID0gKGNyZWVwIDpTY3JlZXAsIGpvYjpKb2IpID0+IHtcbiAgICBNZW1vcnlbJ2pvYl93b3JrZXJzJ11bam9iLm5hbWVdID0gY3JlZXAubmFtZTtcbiAgICBqb2IuY3JlZXAgPSBjcmVlcDtcbiAgICBjcmVlcC5qb2IgPSBqb2I7XG59XG5cblxudmFyIFJvbGVzOiB7IFtpbmRleDogc3RyaW5nXTogSm9iRnVuYyB9ID0ge1xuICAgIG1lZ2FNaW5lcjogKGNyZWVwOiBTY3JlZXAsIGpvYjogSm9iKTogbnVtYmVyID0+IHtcbiAgICAgICAgY3JlZXAubG9nKGpvYi5uYW1lKVxuICAgICAgICB2YXIgc291cmNlSWQgPSBjcmVlcC5tZW1vcnkuc0lkO1xuXG4gICAgICAgIHZhciBzb3VyY2U7XG4gICAgICAgIGlmIChzb3VyY2VJZCAhPSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHNvdXJjZSA9IEdhbWUuZ2V0T2JqZWN0QnlJZChzb3VyY2VJZCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHNvdXJjZSA9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGlmICghY3JlZXAucG9zLmlzTmVhclRvKGpvYi5zdGFydCkpIHtcbiAgICAgICAgICAgICAgICBjcmVlcC5tb3ZlVG8oam9iLnN0YXJ0LCB7IHJldXNlUGF0aDogMjAsIG1heE9wczogMTAwMCB9KVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY3JlZXAubG9nKGpvYi5zdGFydClcbiAgICAgICAgICAgIHNvdXJjZSA9IGpvYi5zdGFydC5wb3MuZmluZENsb3Nlc3RCeVJhbmdlKEZJTkRfU09VUkNFUylcbiAgICAgICAgICAgIGlmIChzb3VyY2UgIT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgY3JlZXAubWVtb3J5LnNJZCA9IHNvdXJjZS5pZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgIGlmIChzb3VyY2UgIT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICB2YXIgZXJyID0gY3JlZXAuaGFydmVzdChzb3VyY2UpO1xuICAgICAgICAgaWYgKGVyciA9PSBFUlJfTk9UX0lOX1JBTkdFKSB7XG4gICAgICAgICAgICAgZXJyID0gY3JlZXAubW92ZVRvKHNvdXJjZSk7XG4gICAgICAgICB9IFxuICAgICAgIH1cbiAgICAgICByZXR1cm4gZXJyO1xuICAgIH1cblxufVxuXG52YXIgRmlsdGVyczogeyBbaW5kZXg6IHN0cmluZ106IENyZWVwRmlsdGVyIH0gPSB7XG4gICAgd29ya3NBbmRNb3ZlczogKGNyZWVwOiBTY3JlZXApID0+IHtcbiAgICAgICAgcmV0dXJuIGNyZWVwLmNhbldvcmsoKSAmJiBjcmVlcC5jYW5Nb3ZlKCk7XG4gICAgfVxuXG59XG5cbnZhciBDbXA6IHsgW2luZGV4OiBzdHJpbmddOiBDcmVlcENtcCB9ID0ge1xuICAgIHdvcmtzSGFyZDogKGE6IFNjcmVlcCwgYjogU2NyZWVwKTogbnVtYmVyID0+IHtcbiAgICAgICAgcmV0dXJuIGIuaG93TWFueVBhcnRzKFdPUkspIC0gYS5ob3dNYW55UGFydHMoV09SSylcbiAgICB9LFxuICAgIC8vIGNsb3NlVG9TdGFydDogKGE6Q3JlZXAsIGI6Q3JlZXApIDogbnVtYmVyID0+IHtcbiAgICAvLyAgICAgcmV0dXJuIGEucG9zLmdldFJhbmdlVG8oY3JlZXAuam9iLnN0YXJ0KSAtIGIucG9zLmdldFJhbmdlVG8oY3JlZXAuam9iLnN0YXJ0KTtcbiAgICAvLyB9XG59XG5cbnZhciBqb2JzOiBKb2JbXSA9IFt7XG4gICAgbmFtZTogXCJtZWdhX21pbmVyXzFcIixcbiAgICBzdGFydDogR2FtZS5mbGFnc1snTWluZV8xXzEnXSxcbiAgICBqb2JGdW5jOiBSb2xlc1snbWVnYU1pbmVyJ10sXG4gICAgY2FuZGlkYXRlRmlsdGVyOiBGaWx0ZXJzWyd3b3Jrc0FuZE1vdmVzJ10sXG4gICAgY2FuZGlkYXRlQ21wOiBDbXBbJ3dvcmtzSGFyZCddXG59LHtcbiAgICBuYW1lOiBcIm1lZ2FfbWluZXJfMlwiLFxuICAgIHN0YXJ0OiBHYW1lLmZsYWdzWydNaW5lXzFfMiddLFxuICAgIGpvYkZ1bmM6IFJvbGVzWydtZWdhTWluZXInXSxcbiAgICBjYW5kaWRhdGVGaWx0ZXI6IEZpbHRlcnNbJ3dvcmtzQW5kTW92ZXMnXSxcbiAgICBjYW5kaWRhdGVDbXA6IENtcFsnd29ya3NIYXJkJ11cbn1dXG5cblxuLy8gVE9ETzogQVBJIHRvIGFkZCBqb2JzLCBzb21lIHdheSB0byBjb21iaW5lIGluLW1lbW9yeSBqb2JzIHdpdGggaW4tY29kZSBqb2JzXG4vLyBmaXRuZXNzIGZ1bmMgZm9yIGNhbmRpZGF0ZXMgYmFzZWQgb24gZGlzdGFuY2UuXG5cbmlmIChNZW1vcnlbJ2pvYl93b3JrZXJzJ10gPT0gdW5kZWZpbmVkKSB7XG4gICAgY29uc29sZS5sb2coXCJyZXBsYWNpbmcgd29ya2VyIG1hcDEhIVwiKVxuICAgIE1lbW9yeVsnam9iX3dvcmtlcnMnXSA9IHt9XG59XG4vLzoge1tpbmRleDpzdHJpbmddOnN0cmluZ31cblxuLy8gOiBmdW5jdGlvbihDcmVlcCk6Ym9vbGVhbiBcblxuLy92YXIgY3JlZXBzIDoge1tpbmRleDpudW1iZXJdOkNyZWVwLCBwdXNoKGM6Q3JlZXApLGZpbHRlcihmbikgfSA9IFtdXG52YXIgY3JlZXBzOlNjcmVlcFtdID0gW11cbmZvciAodmFyIG4gb2YgT2JqZWN0LmtleXMoR2FtZS5jcmVlcHMpKSB7XG4gICAgY3JlZXBzLnB1c2goR2FtZS5jcmVlcHNbbl0pXG59XG5cbnZhciBzZWVuSm9iczogeyBbaW5kZXg6IHN0cmluZ106IGJvb2xlYW4gfSA9IHt9XG52YXIgZW1wdHlKb2JzOkpvYltdID0gW11cblxuXG5mb3IgKHZhciBqb2Igb2Ygam9icykge1xuICAgIC8vIENoZWNrIGZvciBEdXBlXG4gICAgaWYgKHNlZW5Kb2JzW2pvYi5uYW1lXSkge1xuICAgICAgICBjb25zb2xlLmxvZyhcIkRVUExJQ0FURSBKT0IgSU4gTElTVCEhIFwiICsgam9iLm5hbWUpXG4gICAgfVxuICAgIHNlZW5Kb2JzW2pvYi5uYW1lXSA9IHRydWVcblxuICAgIHZhciBjcmVlcE5hbWUgOnN0cmluZyA9IE1lbW9yeVsnam9iX3dvcmtlcnMnXVtqb2IubmFtZV07XG4gICAgdmFyIGNyZWVwIDogU2NyZWVwO1xuICAgIGlmIChjcmVlcE5hbWUgIT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGNyZWVwID0gR2FtZS5jcmVlcHNbY3JlZXBOYW1lXVxuICAgICAgICBpZiAoY3JlZXAgPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIkJhZCBjcmVlcCBmb3VuZCwgcmVwbGFjaW5nOiBcIiArIEpTT04uc3RyaW5naWZ5KGNyZWVwKSlcbiAgICAgICAgICAgIGRlbGV0ZSBNZW1vcnlbJ2pvYl93b3JrZXJzJ11bam9iLm5hbWVdO1xuICAgICAgICAgICAgY3JlZXBOYW1lID0gdW5kZWZpbmVkO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc2V0Sm9iKGNyZWVwLCBqb2IpO1xuICAgICAgICB9XG5cbiAgICB9XG4gICAgaWYoY3JlZXBOYW1lID09IHVuZGVmaW5lZCkge1xuICAgICAgICBlbXB0eUpvYnMucHVzaChqb2IpXG4gICAgfVxufVxuXG52YXIgbm9Kb2IgPSAoYyA6IFNjcmVlcCk6Ym9vbGVhbiA9PiB7XG4gICAgcmV0dXJuIGMuam9iID09IHVuZGVmaW5lZFxufVxuXG5cbmZvciAodmFyIGpvYiBvZiBlbXB0eUpvYnMpIHtcbiAgICAvL3BpY2sgbmV3IG9uZVxuICAgIGNvbnNvbGUubG9nKFwiTmVlZCB0byByZXBsYWNlIGNyZWVwIGZvciBqb2IgXCIgKyBqb2IubmFtZSlcbiAgICAvLyBUT0RPIGZpZ3VyZSBvdXQgY3VycnlpbmcgdG8gcGFzcyBqb2IgaW50byBjbXAgZnVuY3Rpb25cbiAgICAvLyBUT0RPIGZpbHRlciBvdXQgY3JlZXBzIHdpdGggam9ic1xuICAgIHZhciBjYW5kaWRhdGVzIDogU2NyZWVwW10gPSBjcmVlcHMuZmlsdGVyKG5vSm9iKS5maWx0ZXIoam9iLmNhbmRpZGF0ZUZpbHRlcikuc29ydChqb2IuY2FuZGlkYXRlQ21wKVxuICAgIGlmIChjYW5kaWRhdGVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgdmFyIGNyZWVwIDogU2NyZWVwID0gY2FuZGlkYXRlc1swXTtcbiAgICAgICAgY29uc29sZS5sb2coXCJQaWNrZWQgY3JlZXAgZm9yIGpvYiBcIiArIGpvYi5uYW1lICsgXCIgZ290IFwiICsgY3JlZXAubmFtZSk7XG4gICAgICAgIHNldEpvYihjcmVlcCwgam9iKTtcbiAgICAgICAgLy8gY2FsbCBzZXRKb2I/Pz9cbiAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmxvZyhcIm5vIGNhbmRpZGF0ZXMgZm9yIGpvYj1cIiArIGpvYi5uYW1lKVxuICAgICAgICBjb250aW51ZTtcbiAgICB9XG59XG4gXG5qb2IgPSBudWxsXG5mb3IgKGNyZWVwIG9mIGNyZWVwcykge1xuICAgIGlmIChjcmVlcC5qb2IgIT0gdW5kZWZpbmVkKXtcbiAgICAgICAgY3JlZXAubG9nKFwiam9iPVwiK2NyZWVwLmpvYi5uYW1lKVxuICAgICAgICBjcmVlcC5qb2Iuam9iRnVuYyhjcmVlcCwgY3JlZXAuam9iKVxuICAgIH0gZWxzZSB7XG4gICAgICAgIGNyZWVwLmxvZyhcIk5vdGhpbmcgdG8gZG9cIilcbiAgICB9XG59Il19